## 主从复制
### 哨兵模式
主节点Master 只有一个，一旦主节点挂掉之后(启动后还是主节点)，从节点没法担起主节点的任务，
那么整个系统也无法运行。
如果主节点挂掉之后，从节点能够自动变成主节点，那么问题就解决了，于是哨兵模式诞生了。

哨兵模式就是不停的监控 redis 是否按照预期良好的运行(至少保存主节点是存在的), 若主节点出现问题,
哨兵会自动将该主机下的某一个从机设置为新的主机, 并让其它从机和新主机建立从关系.
> PS：哨兵模式也存在单点故障问题，如果哨兵机器挂了，
那么就无法进行监控了，解决办法是哨兵也建立集群，Redis哨兵模式是支持集群的。

### 主从复制原理
Redis的复制功能分为同步（sync）和命令传播（command propagate）两个操作。

#### 建立连接并同步
当从节点发出 SLAVEOF 命令, 要求从服务器复制主服务器时, 从服务器通过向主服务器发送 SYNC 命令来完成.
该命令执行步骤:
 1. 从服务器向主服务器发送 SYNC 命令
 2. 收到 SYNC 命令的主服务器执行 BGSAVE 命令，
        在后台生成一个 RDB 文件，并使用一个缓冲区记录所有写命令
 3. 当主服务器的 BGSAVE 命令执行完毕时，主服务器会将 BGSAVE 命令生成的 RDB 文件发送给从服务器，
        从服务器接收此 RDB 文件，并将服务器状态更新为RDB文件记录的状态.
 4. 主服务器将缓冲区的所有写命令也发送给从服务器，从服务器执行相应命令
 
#### 命令传播
服务器会进行相应的修改命令，这时候从服务器和主服务器状态就会不一致。

为了让主服务器和从服务器保持状态一致，主服务器需要对从服务器执行命令传播操作，
主服务器会将自己的写命令发送给从服务器执行。从服务器执行相应的命令之后，
主从服务器状态继续保持一致。

如果期间从服务器断开了一段时间，此时从服务器再启动如果执行同步命令, 那主服务器需要启动 bgsave 重型
操作, 并且加载期间从服务器时无法处理其它命令的。

为了解决这个问题，Redis从2.8版本之后，使用了新的同步命令 `PSYNC` 来代替 SYNC 命令。
该命令的部分重同步功能用于处理断线后重复制的效率问题。
也就是说当从服务器在断线后重新连接主服务器时，
主服务器只将断开连接后执行的写命令发送给从服务器，
从服务器只需要接收并执行这些写命令即可保持主从一致。


### 主从复制的缺点
主从复制虽然解决了主节点的单点故障问题，但是由于所有的写操作都是在 Master 节点上操作，
然后同步到 Slave 节点，那么同步就会有一定的延时，当系统很繁忙的时候，延时问题就会更加严重，
而且会随着从节点slave的增多而愈加严重。

