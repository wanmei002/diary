> 本文内容来自 《图解TCP/IP》 一书，支持作者，请购买正版图书

### 协议
在计算机网络与信息通信领域里, 人们经常提及`协议`一词。互联网中常用的具有代表性的协议有IP、TCP、HTTP等。而 `LAN(局域网)` 中常用的协议有 `IPX/SPX` 等

计算机必须用相同的协议才能通信，解析通信的内容

#### 分组交换协议
分组交换是指将大数据分割为一个一个叫做包(packet)的较小单位进行传输的方法

计算机通信也会在每一个分组中附加上源主机地址和目标主机地址送给通信线路。这些发送端地址、接收端地址以及分组序号写入的部分称为 `报文首部`

一个较大的数据被分为多个分组时, 为了标明是原始数据中的哪一部分，就有必要将分组的序号写入包中。接收端会根据这个序号，再将每个分组按照序号重新装配为原始数据

#### 协议的标准化
由于各个厂商采用的协议不同，不能互相通信，导致沟通不通畅。此时 ISO(国际标准化组织)制定了一个国际标准OSI, OSI协议并没有得到普及，但是 OSI参考模型却常被用于网络协议的制定当中

TCP/IP并非 ISO 所制定的某种国际标准。 而是由 `TETF` 组织所建议的、致力于推进其标准化作业的一种协议 

### 七层模型
#### 应用层
该协议会在所要传送数据的前端附加一个首部(标签)信息，信息里包含了要发送的内容

#### 表示层
将数据从 `某个计算机特定的数据格式` 转换为 `网络通用的标准数据格式(编码)`后再发出去, 表示层与表示层之间为了识别编码格式也会附加首部信息

#### 会话层
采用何种连接发送数据，也会在数据前端附加首部或标签信息后转发给下一层

#### 传输层
主机A确保与主机B之间的通信并准备发送数据，这一过程叫做 `建立连接`, 此外当通信传输结束后, 有必要将连接断开

如上，建立连接或断开连接的处理，在两个主机之间创建逻辑上的通信连接即是传输层的主要作用。此外，传输层为确保传输数据到达目的地址，
会在通信两端的计算机之间进行确认，如果数据没有到达，它会负责进行重发，保证数据的可靠性是传输层的一个重要作用。为了确保可靠性，
在这一层也会为所要传输的数据附加首部以识别这一分层的数据

#### 网络层
网络层的作用是在网络与网络相互连接的环境中，将数据从发送端主机发送到接收端主机

#### 数据链路层
通过传输介质互连的设备之间进行数据处理  像网桥 二层交换机就是工作在这一层

#### 物理层
将数据 0 1 转换为电压和脉冲光传输给物理的传输介质，而相互直连的设备之间使用地址实现传输，这种地址被称为 MAC 地址, 也可称为物理地址或硬件地址
. 采用 MAC,目的是为了识别连接到同一个传输介质上的设备。因此，在这一层中将包含MAC地址信息的首部附加到从网络层转发过来的数据，将其发送到网络。

> 每个分层上的协议规定了该分层中数据首部的格式以及首部与处理数据的顺序

#### 面向有连接型和面向无连接型
TCP 这样就是有连接型 需要建立连接后才能通信
UDP 就是无连接型 不需要知道目标地址是否存在 或是否收取信息，只管发送

#### 电路交换与分组交换
##### 电路交换
电路交换技术的历史相对久远，主要用于过去的电话网。

数据传输线路是抢占式的，占有线路的计算机传输完成了，其它计算机才能传输数据

##### 分组交换
分组交换技术是一种较新的通信方式, TCP/IP 正是采用了分组交换技术

连接通信电路的计算机将所要发送的数据分成多个数据包

分组交换的大致处理过程: 发送端计算机将数据分组发送给路由器, 路由器收到这些分组数据以后，缓存到自己的缓冲区，然后再转发给目标计算机。
> 路由器接收到数据以后会按照顺序缓存到相应的队列当中，再以先进先出的顺序将它们逐一发送出去

#### 地址
TCP/IP 通信中使用 MAC 地址、IP地址、端口号等信息作为地址标识。甚至在应用层中可以将电子邮件地址作为网络通信的地址


#### 网络的构成要素
 - 网卡 : 使计算机连网的设备
 - 中继器: 从物理层上延长网络的设备
 - 网桥/2层交换机: 从数据链路层上延长网络的设备
 - 路由器/3层交换机: 通过网络层转发分组数据的设备
 - 4~7层交换机: 处理传输层以上各层网络传输的设备
 - 网关: 转换协议的设备
 
##### 网卡
 网络接口卡: 又名 网络适配器、网卡、LAN卡，任何一台计算机连接网络时，必须要使用网卡

##### 中继器
中继器是在OSI模型的第1层-物理层上延长网络的设备。又电缆传过来的电信号或光信号经由中继器的波形调整和放大再传给另一个电缆

##### 网桥/2层交换机
多台计算机使用一个网络接口可以同时与多台电脑通信，将电脑连接起来的黑盒子一开始是集线器(hub)，集线器发送信息采用广播形式，所有集线器上的设备都可以收到信息，它们可以根据数据里的MAC地址来区分是否是发送给自己的

后来随着设备的增多、数据量的增多需要更准确的发送数据，此时再集线器的基础上增加了 MAC 学习，这就是网桥

来个网桥的栗子: 
 - 主机A发送一条数据给主机B, 中间经过网桥，此时网桥B不知道那个是主机B，广播发送，主机B收到了消息，此时网桥记住了主机A主机的MAC地址并对应哪个网络和主机B的MAC地址
 - 此时主机B发送数据给主机A，经过网桥，网桥通过内部的内存表(MAC=>网络)知道了主机A是哪个网络，直接发送数据给A所在的网络， 不需要广播。 此时网桥记住了主机B的MAC地址对应哪个网络
 - 主机A发送数据给主机B就直接发送了
 
> 网桥就是组成局域网的那台设备

##### 路由器/3层交换机
路由器是在OSI模型的第3层-网络层上连接两个网络、并对分组报文进行转发的设备。
网桥是根据物理地址(MAC地址)进行处理，
而路由器/3层交换机则是根据IP地址进行处理的。由此, TCP/IP 中网络层的地址就成为了IP地址

路由器可以连接不同的数据链路。连接两个以上的以太网，或者连接一个以太网与一个FDDI。现在家里或办公室里连接互联网时所使用的宽带路由器也是路由器的一种

路由器还有分担网络负荷的作用。甚至有些路由器具备一定的网络安全功能

##### 4~7层交换机
4~7层交换机负责处理OSI模型中从传输层至应用层的数据，如果用 TCP/IP 分层模型来表述, 4~7层交换机就是以 TCP 
等协议的传输层及其上面的应用层为基础，分析收发数据，并对其进行特定的处理

实际通信当中，人们希望在网络比较拥堵的时候，优先处理像语音这类对及时性要求较高的通信请求，放缓处理像邮件或数据转发等稍有延迟也并无大碍的通信请求。
这种处理被称为宽带控制, 也是 4~7层交换机的重要功能之一

> 为了能通过同一个URL将前端访问分发到后台多个服务器上, 可以在这些服务器的前端加一个负载均衡器(LVS)。这个负载均衡器就是4~7层交换机的一种


##### 网关
网关是OSI参考模型中负责将从传输层到应用层的数据进行转换和转发的设备，他与 4~7层交换机一样都是处理传输层及以上的数据，但是网关
不仅转发数据 还负责对数据进行转换，它通常会使用一个表示层或应用层网关，在两个不能进行直接通信的协议之间进行翻译，最终实现两者之间的通信


### TCP/IP 的标准化
#### TCP/IP 的具体含义
有人可能会认为 TCP/IP 是指 TCP 与 IP 两种协议。实际生活当中有时也确实就是指这两种协议。
然而很多情况下，它只是利用IP进行通信时所必须用到的协议群的统称。
具体来说，IP/ICMP、TCP/UDP、TELNET/FTP、以及HTTP等都属于TCP/IP的协议。它们与TCP或IP的关系紧密，时互联网必不可少的组成部分

##### IP
IP 是跨越网络传送数据包，使整个互联网都能收到数据的协议。IP协议使数据能够发送到地球的另一端，这期间
它使用 IP 地址作为主机的标识

##### ICMP
IP 数据包在发送途中一旦发生异常导致无法到达对端目标地址时, 需要给发送端发送一个发生异常的通知。ICMP 就是为
这一功能而定制的。它有时也被用来诊断网络的健康状况

##### ARP
从分组数据包的IP地址中解析出物理地址(MAC地址) 的一种协议

#### 传输层
传输层最主要的功能就是能够让应用程序之间实现通信.计算机内部，通常同一时间运行着多个程序，为此，必须分清是哪些程序与
哪些程序在进行通信。识别这些应用程序的是端口号

##### TCP
TCP 是一种面向有连接的传输层协议。它可以保证两端通信主机之间的通信可达。TCP能够正确处理在传输过程中丢包、传输顺序乱掉等异常情况。
此外，TCP还能有效利用带宽，缓解网络拥堵。

然而，为了建立与断开连接，有时它需要至少7次的发包收包，导致网络流量的浪费。此外，为了提高网络的利用率，TCP协议中定义了各种各样复杂的规范，
因此不利于视频会议(音频、视频的数据量既定)等场合使用

##### UDP
UDP有别于TCP，他是一种面向无连接的传输协议。UDP不会关注对端是否真的收到了传送过去的数据，如果需要检查对端是否收到分组数据包，或者
对端是否连接到网络，则需要在应用程序中实现。
UDP常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域

#### 应用层(会话层以上的分层)
TCP/IP 的分层中, 将OSI参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。这些功能有时由一个单一的程序实现，有时也可能会由多个程序实现。
因此，细看TCP/IP的应用程序功能会发现，它不仅实现OSI模型中应用层的内容，还要实现会话层与表示层的功能。

##### WWW
WWW(万维网)，是一种互联网上数据读取的规范。WWW中的HTTP属于OSI应用层的协议，而HTML属于表示层的协议

##### SMTP(电子邮件协议)

##### FTP(文件传输协议)
在FTP中进行文件传输时会建立两个TCP连接, 分别是发出传输请求时所要用到的控制连接与实际传输数据时所要用到的数据连接

##### TELNET与SSH (远程登录协议)

##### SNMP (网络管理)
在 TCP/IP 中进行网络管理时, 采用 SNMP(Simple Network Management Protocol) 协议。
使用SNMP 管理的主机、网桥、路由器等称作 SNMP 代理(Agent), 而进行管理的那一段叫做管理器(Manager)。
SNMP 正是这个 Manger 与 Agent 所要用到的协议。

### TCP/IP 分层模型与通信示例
每个分层中， 都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。

网络中传输的数据包由两部分组成: 一部分是协议所要用到的首部，另一部分是上层传过来的数据。
在数据包的首部，明确标明了协议应该如何读取数据。反过来说，看到首部，也就能够了解该协议必要的信息以及所要处理内容。
因此，看到包首部就如同看到协议的规范。

#### 发送数据包
##### 应用程序处理
用户由键盘输入内容 `早上好`, 鼠标点击发送按钮就可以开始 TCP/IP 通信了
 - 首先，应用程序中会进行编码处理。例如，对内容进行UTF-8编码。这些编码相当于 OSI 的表示层功能。
 - 编码转化后，实际邮件不一定会马上被发送出去，因为有些邮件的软件有一次同时发送多个邮件的功能，也有可能
 会有用户点击 `收信` 按钮以后才一并接受新邮件的功能。像这种何时建立通信连接何时发送数据的管理功能，从某种宽泛
 的意义上看属于OSI参考模型中会话层的功能。应用在发送邮件的那一刻建立TCP连接，从而利用这个TCP连接发送数据。
 它的过程首先是将应用的数据发送给下一层的TCP，再做实际的转发处理。
 - TCP模块的处理: TCP根据应用的指示，负责建立连接、发送数据以及断开连接。TCP提供将应用层发来的数据顺利发送至对端的可靠传输。
 为了实现TCP这一功能，需要在应用层数据的前端附加一个 TCP 首部。TCP首部中包括源端口号和目标端口号(用于识别发送主机跟接收主机上的应用)、
 序号(用于发送的包中哪部分是数据)、以及校验和。随后将附加了 TCP 首部的包再发送给 IP。
 - IP模块的处理: IP 将 TCP 传过来的 TCP 首部和 TCP 数据合起来当做自己的数据，并在TCP首部的前端在加上自己的IP首部。
 IP 首部中包含接收端IP地址以及发送端IP地址。紧随IP首部的还有用来判断其后面数据是 TCP 还是 UDP的信息。
 
 IP包生成后，参考路由控制表决定接受此 IP 包的路由或主机。随后，IP包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正发送数据。
 如果尚不知道接收端的 MAC 地址，可以利用 ARP 查找。只要知道了对端的 MAC 地址，就可以将 MAC 地址和 IP地址交给以太网的驱动程序，实现数据传输。
 
 - 网络接口(以太网驱动)的处理: 从IP传过来的IP包，对于以太网驱动来说不过就是数据。给这数据附加上以太网首部并进行发送处理。以太网首部中包含接收端MAC地址、
 发送端 MAC 地址以及标志以太网类型的以太网数据的协议。根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的FCS 由硬件计算，
 添加到包的最后。设置 FCS 的目的是为了判断数据包是否由于噪声而被破坏。
 
![流程图](./data_header_add.png)

上图对各个包首部做了简化

#### 经过数据链路的包
每个包的首部中至少会包含两个信息: 一个是发送端和接收端地址，另一个是上一层的协议类型。

经过每个协议分层时，都必须有识别包发送端和接收端的信息。以太网会用MAC地址，IP会用IP地址，而TCP/UDP则会用端口号作为识别两端主机的
地址。

![数据组成](./data_partition.png)

#### 数据包接收处理
包的接收流程时发送流程的逆序过程

##### 网络接口(以太网驱动)的处理
主机收到以太网包以后，首先从以太网的包首部找到 MAC地址，判断是否为发给自己的包。如果不是发给自己的包则丢弃数据。

而如果接收到了恰好是发给自己的包，就查找以太网包首部中的类型域从而确定以太网协议所传送过来的数据类型。
这个例子中数据类型显然是 IP 包，因此再将数据传给处理 IP 的子程序，如果这时不是 IP 而是其它诸如 ARP 的协议，就把数据传给 ARP 处理。总之，
如果以太网首部的类型域包含了一个无法识别的协议类型，则丢弃数据。

##### IP 模块的处理
IP模块收到IP包首部及后面的数据部分以后，也做类似的处理。如果判断得出包首部中的IP地址与自己的IP地址匹配，则可接收
数据并从中查找上一层的协议。如果上一层是 TCP 就将 IP 包首部之后的部分传给 TCP 处理；如果是 UDP 则将 IP 包首部
后面的部分传给 UDP 处理。对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，再调查应该送达的主机或路由器以后再转发数据。

##### TCP 模块的处理
在TCP 模块中，首先会计算一下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。

数据接收完毕后，接收端则发送一个 `确认回执` 给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

数据被完整的接收以后，会传给由端口号识别的应用程序。

##### 应用程序的处理
接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的收件人地址是乙的地址。
如果主机B上没有乙的邮件信箱，那么主机B返回给发送端一个 `无此收件地址` 的报错信息。

但在这个例子中，主机B上恰好有乙的收件箱，所以主机B和收件人乙能够收到电子邮件的正文。邮件会被保存到本机的硬盘上。如果保存不能正常进行就会返回
一个 `处理异常` 的回执给发送端。处理正常则返回一个 `处理正常` 的回执给发送端。

### 数据链路层
本章主要介绍计算机网络最基本的内容——数据链路层。如果没有数据链路层，基于TCP/IP的通信也就无从谈起。
本章将着重介绍 TCP/IP 的具体数据链路，如以太网、无线局域网、PPP等。

数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范。

通信媒介包括双绞线电缆、同轴电缆、光纤、电波以及红外线等介质。此外各个设备之间有时也会通过交换机、网桥、中继器等中转数据。

把电信号 与 0 1 进行转换的正式物理层，数据链路层处理的数据也不是单纯的 0 1 序列，该层把它们集合为一个叫做
`帧` 的块，然后再进行传输。

数据链路层的相关技术，包括 MAC 寻址(物理寻址)、介质共享、非公有网络、分组交换、环路检测、VLAN、
等。作为传输方式的数据链路 如以太网、WLAN、PPP等概念。

##### 非共享介质网络
非共享介质网络是指不共享介质，是对介质采取专用的一种传输控制方式。在这种方式下，网络中的每个站直连交换机，
由于交换机负责转发数据帧。此方式下，发送端与接收端并不共享通信介质，因此很多情况下采用全双工通信方式。

这种方式有一个致命的弱点，一旦交换机发生故障，与之相连的所有计算机都将无法通信。

##### 以太网 帧格式
以太网帧前端有一个叫做前导码的部分, 它由 0、1数字交替组合而成，表示一个以太帧的开始，也是对端网卡能够确保与其同步的标志。
前导码末尾是一个叫做 SFD 的域，它的值是 `11`。在这个域之后就是以太网帧的本体。前导码与SFD合起来占 8 个字节。

以太网帧本体的前端是以太网的首部, 它总共占14个字节。分别是 6 个字节的目标MAC地址、6个字节的源MAC地址以及2个字节的上层协议类型。

![前导码](./the_internet_before.png)

![以太网帧本体](./the_internet_body.png)


### IP
#### IP 即网际协议
##### IP相当于 OSI参考模型的第三层(网络层)







